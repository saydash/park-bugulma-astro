---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getPosts, getCleanText, getFeaturedImage } from '../utils.js';

const posts = await getPosts();
const CAT_REPORTS = 6;
const reportsPosts = posts.filter(p => p.categories.includes(CAT_REPORTS));

// 1. Извлекаем уникальные года из дат постов и сортируем их (свежие сверху)
const years = [...new Set(reportsPosts.map(post => new Date(post.date).getFullYear()))].sort((a, b) => b - a);

const pageTitle = "Как это было — Архив событий";
---

<BaseLayout title={pageTitle}>
  <div class="bg-white min-h-screen">
    
    <!-- ЗАГОЛОВОК СТРАНИЦЫ -->
    <header class="max-w-7xl mx-auto px-6 pt-32 pb-16">
      <div class="flex flex-col md:flex-row justify-between items-baseline gap-8 mb-16">
        <h1 class="text-6xl md:text-[120px] font-black tracking-tighter uppercase text-[#222222] leading-[0.85]">
          Как это <br/> <span class="font-light italic text-teal-600 opacity-30">было</span>
        </h1>
        <div class="text-[11px] font-bold text-[#222222]/40 uppercase tracking-[0.4em] max-w-[250px] leading-relaxed">
          Архив прошедших мероприятий и фотоотчеты за все годы работы парка
        </div>
      </div>

      <!-- ФИЛЬТР ПО ГОДАМ (В стиле Казани) -->
      <div class="flex flex-wrap items-center gap-x-12 gap-y-4 border-t border-b border-[#e5e5e5] py-8">
        <span class="text-[10px] font-black uppercase tracking-[0.3em] text-teal-600">Выбрать год:</span>
        <div class="flex flex-wrap gap-8">
          {years.map(year => (
            <button 
              class="year-filter text-sm font-bold text-[#222222]/40 hover:text-teal-600 uppercase tracking-widest transition-all cursor-pointer relative py-2 active:scale-95"
              data-year={year}
            >
              {year}
            </button>
          ))}
          <button 
            class="year-filter text-sm font-bold text-teal-600 uppercase tracking-widest transition-all cursor-pointer py-2"
            data-year="all"
          >
            Все время
          </button>
        </div>
      </div>
    </header>

    <!-- СПИСОК ОТЧЕТОВ -->
    <section class="max-w-7xl mx-auto px-6 py-10">
      <div id="reports-grid" class="flex flex-col gap-px bg-[#e5e5e5] border border-[#e5e5e5] overflow-hidden rounded-[20px] shadow-sm">
        {reportsPosts.map((post) => (
          <div 
            class="report-item group flex flex-col md:flex-row items-center gap-10 bg-white p-10 no-underline transition-all duration-500 hover:bg-[#fafafa]"
            data-year={new Date(post.date).getFullYear()}
          >
            <!-- Фото слева -->
            <div class="w-full md:w-80 h-56 bg-[#f4f4f4] overflow-hidden rounded-xl flex-shrink-0 relative">
              <img src={getFeaturedImage(post)} class="w-full h-full object-cover transition-transform duration-1000 group-hover:scale-105" alt="" />
            </div>

            <!-- Контент справа -->
            <div class="flex-grow py-2">
              <div class="flex items-center gap-4 mb-4">
                <time class="text-[10px] font-bold text-teal-600 uppercase tracking-[0.3em]">
                   {new Date(post.date).toLocaleDateString('ru-RU', { day: 'numeric', month: 'long', year: 'numeric' })}
                </time>
              </div>
              <a href={`/events/${post.slug}`} class="no-underline block group">
                <h2 class="text-3xl font-bold text-[#222222] leading-tight mb-4 group-hover:text-teal-700 transition-colors" set:html={post.title.rendered} />
              </a>
              <p class="text-[#222222]/50 text-sm max-w-2xl line-clamp-2 leading-relaxed font-light mb-8">
                {getCleanText(post.content.rendered).substring(0, 150)}...
              </p>
              <a href={`/events/${post.slug}`} class="inline-flex items-center text-[10px] font-black uppercase tracking-[0.2em] text-[#222222] group-hover:text-teal-600 no-underline">
                Подробнее <span class="ml-3 text-lg">→</span>
              </a>
            </div>
          </div>
        ))}
      </div>
    </section>

    <script>
      // Простая логика фильтрации без перезагрузки страницы
      const buttons = document.querySelectorAll('.year-filter');
      const items = document.querySelectorAll('.report-item');

      buttons.forEach(btn => {
        btn.addEventListener('click', () => {
          const selectedYear = btn.getAttribute('data-year');
          
          // Визуальный акцент на кнопке
          buttons.forEach(b => b.classList.replace('text-teal-600', 'text-[#222222]/40'));
          btn.classList.replace('text-[#222222]/40', 'text-teal-600');

          // Фильтрация элементов
          items.forEach(item => {
            const itemYear = item.getAttribute('data-year');
            if (selectedYear === 'all' || itemYear === selectedYear) {
              (item as HTMLElement).style.display = 'flex';
            } else {
              (item as HTMLElement).style.display = 'none';
            }
          });
        });
      });
    </script>
  </div>
</BaseLayout>
